// src/lib/sendMail.ts
//
// ÅTERINFÖRDA & FÖRBÄTTRADE MAILMALLAR (Helsingbuss-stil)
// - Kundkvitto (receipt) till kundens e-post
// - Admin-notis till OFFERS_INBOX
// - Offertmail till kund (Visa & bekräfta)
// Miljöstyrt med Resend. Stöd för MAIL_FORCE_TO och BCC.

import { Resend } from "resend";
import { createOfferToken, buildOfferPublicLink, buildAdminOfferLink, CUSTOMER_BASE_URL, LOGIN_BASE_URL } from "@/lib/offerToken";

// ====== ENV helpers ======
const env = (k: string, fb?: string) => (process.env[k] && process.env[k]!.trim() !== "" ? process.env[k]! : (fb ?? ""));
const RESEND_API_KEY = env("RESEND_API_KEY", "");
const MAIL_FROM        = env("MAIL_FROM", env("EMAIL_FROM", "Helsingbuss <info@helsingbuss.se>"));
const EMAIL_REPLY_TO   = env("EMAIL_REPLY_TO", "");
const OFFERS_INBOX     = env("OFFERS_INBOX", env("ADMIN_ALERT_EMAIL", "info@helsingbuss.se"));
const ADMIN_ALERT_EMAIL= env("ADMIN_ALERT_EMAIL", "");
const MAIL_FORCE_TO    = env("MAIL_FORCE_TO", "");              // tvinga all leverans till denna adress (testläge)
const MAIL_BCC_ALL     = env("MAIL_BCC_ALL", "");               // kommaseparerad lista
const BRAND_COLOR      = "#194C66";
const BRAND_BG_SOFT    = "#e5eef3";
const BRAND_BG         = "#f5f4f0";

function commaSplit(v?: string) {
  return (v || "").split(",").map(s => s.trim()).filter(Boolean);
}

function pickEmail(...cands: Array<any>): string | undefined {
  for (const c of cands) {
    const s = (c ?? "").toString().trim();
    if (s && s.includes("@")) return s;
  }
  return undefined;
}

function safeTo(to: string | string[]): string[] {
  const list = Array.isArray(to) ? to : [to];
  const final = list.filter(Boolean);
  if (MAIL_FORCE_TO) return [MAIL_FORCE_TO];
  return final;
}

function absUrl(base: string, path: string) {
  const b = (base || "").replace(/\/+$/, "");
  const p = path.startsWith("/") ? path : `/${path}`;
  return `${b}${p}`;
}

// ====== Layout wrapper (behåll look & feel, bara städat) ======
function wrapHtml(options: { title: string; preheader?: string; body: string }) {
  const { title, preheader = "", body } = options;

  // preheader göms i inkorg men syns som preview-textrad
  const preheaderSpan = preheader
    ? `<span style="display:none;visibility:hidden;opacity:0;color:transparent;height:0;width:0;overflow:hidden;mso-hide:all;">${escapeHtml(preheader)}</span>`
    : "";

  return `<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width"/>
  <title>${escapeHtml(title)}</title>
</head>
<body style="margin:0;padding:0;background:${BRAND_BG};font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:#111;">
  ${preheaderSpan}
  <table role="presentation" width="100%" cellpadding="0" cellspacing="0" style="background:${BRAND_BG};padding:24px 0;">
    <tr>
      <td align="center">
        <table role="presentation" width="640" cellpadding="0" cellspacing="0" style="background:#fff;border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,.05);overflow:hidden;">
          <tr>
            <td style="background:${BRAND_COLOR};padding:16px 24px;">
              <div style="color:#fff;font-weight:700;font-size:18px;line-height:24px;">Helsingbuss</div>
              <div style="color:rgba(255,255,255,.9);font-size:12px;line-height:16px;">Komfort, säkerhet och omtanke</div>
            </td>
          </tr>
          <tr>
            <td style="padding:24px;">
              ${body}
            </td>
          </tr>
          <tr>
            <td style="background:${BRAND_BG_SOFT};padding:16px 24px;color:#194c66;font-size:12px;line-height:18px;">
              Detta e-postmeddelande skickades av Helsingbuss. Behöver du hjälp? Svara på mailet eller kontakta <a href="mailto:${EMAIL_REPLY_TO || "kundteam@helsingbuss.se"}" style="color:${BRAND_COLOR};text-decoration:underline;">kundteamet</a>.
            </td>
          </tr>
        </table>
        <div style="color:#6b7280;font-size:11px;line-height:16px;margin-top:12px;">© ${new Date().getFullYear()} Helsingbuss</div>
      </td>
    </tr>
  </table>
</body>
</html>`;
}

function escapeHtml(s: string) {
  return s.replace(/[&<>"]/g, (c) => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c]!));
}

// ====== Innehållsblock (återanvänds) ======
function sectionTitle(txt: string) {
  return `<h2 style="margin:0 0 8px 0;font-size:16px;line-height:22px;color:${BRAND_COLOR};">${escapeHtml(txt)}</h2>`;
}

function kv(label: string, value: string | number | null | undefined) {
  if (value == null || value === "") return "";
  return `<tr>
    <td style="padding:6px 10px;width:40%;color:#374151;font-size:14px;background:#fafafa;border-bottom:1px solid #f0f0f0;">${escapeHtml(label)}</td>
    <td style="padding:6px 10px;color:#111827;font-size:14px;border-bottom:1px solid #f0f0f0;">${escapeHtml(String(value))}</td>
  </tr>`;
}

function cta(href: string, label = "Öppna") {
  return `<div style="margin:16px 0 4px 0;">
    <a href="${href}" style="display:inline-block;background:${BRAND_COLOR};color:#fff;text-decoration:none;padding:10px 16px;border-radius:999px;font-weight:600;">
      ${escapeHtml(label)}
    </a>
  </div>
  <div style="font-size:12px;color:#6b7280;margin-top:6px;word-break:break-all;">Eller kopiera länken: <span>${escapeHtml(href)}</span></div>`;
}

function itineraryBlock(p: Partial<MailCorePayload>) {
  const hasReturn = !!(p.return_departure || p.return_destination || p.return_date || p.return_time);
  return `
  ${sectionTitle("Reseinformation")}
  <table role="presentation" width="100%" cellpadding="0" cellspacing="0" style="border:1px solid #eee;border-radius:10px;overflow:hidden;">
    ${kv("Från", p.departure_place || p.fromPlace || p.from)}
    ${kv("Till", p.destination || p.toPlace)}
    ${kv("Avresa datum", p.departure_date || p.date)}
    ${kv("Avresa tid", p.departure_time || p.time)}
    ${kv("Passagerare", typeof p.passengers === "number" ? p.passengers : (p.passengers as any) ?? "")}
    ${kv("Via/stop", p.stopover_places)}
    ${hasReturn ? kv("Retur från", p.return_departure || p.return_from) : ""}
    ${hasReturn ? kv("Retur till", p.return_destination || p.return_to) : ""}
    ${hasReturn ? kv("Retur datum", p.return_date) : ""}
    ${hasReturn ? kv("Retur tid", p.return_time) : ""}
    ${kv("Övrigt", p.notes)}
  </table>`;
}

// ====== Payload-typer (bred – tål gamla/nya fältnamn) ======
export type MailCorePayload = {
  offerId: string;
  offerNumber: string;
  // Kundinfo
  to?: string;
  customerEmail?: string;
  customer_email?: string;
  contact_email?: string;
  customerName?: string;
  contact_person?: string;
  customerPhone?: string;
  customer_phone?: string;

  // Primär sträcka
  from?: string;
  fromPlace?: string;
  departure_place?: string;
  toPlace?: string;
  destination?: string;
  date?: string | null;
  departure_date?: string | null;
  time?: string | null;
  departure_time?: string | null;
  passengers?: number | null;
  stopover_places?: string | null;

  // Retur
  return_from?: string | null;
  return_to?: string | null;
  return_date?: string | null;
  return_time?: string | null;
  return_departure?: string | null;
  return_destination?: string | null;

  // Övrigt
  notes?: string | null;

  // valfri extra
  [k: string]: any;
};

type SendOpts = { bccAll?: string[] };

// ====== HTML-mallar ======
function renderCustomerReceiptHTML(p: MailCorePayload, customerUrl: string) {
  const name = p.customerName || p.contact_person || "";
  const header = `<h1 style="margin:0 0 10px 0;font-size:20px;line-height:28px;color:#111;">Tack! Vi har mottagit din offertförfrågan</h1>
  <p style="margin:0 0 16px 0;color:#374151;font-size:14px;">
    ${name ? escapeHtml(name) + ", " : ""}vi återkommer med ett förslag. Du kan följa din offert via knappen nedan.
  </p>`;

  const contactBlock = `
  ${sectionTitle("Dina uppgifter")}
  <table role="presentation" width="100%" cellpadding="0" cellspacing="0" style="border:1px solid #eee;border-radius:10px;overflow:hidden;margin-bottom:12px;">
    ${kv("Namn / referens", name || "—")}
    ${kv("E-post", pickEmail(p.to, p.customerEmail, p.customer_email, p.contact_email) || "—")}
    ${kv("Telefon", p.customerPhone || p.customer_phone || "—")}
  </table>`;

  const body = `
    ${header}
    ${itineraryBlock(p)}
    ${contactBlock}
    ${cta(customerUrl, "Visa din offert")}
  `;
  return wrapHtml({ title: "Bekräftelse på offertförfrågan", preheader: "Vi har mottagit din förfrågan", body });
}

function renderAdminNewOfferHTML(p: MailCorePayload, adminUrl: string) {
  const subjectLine = `${(p.departure_place || p.fromPlace || p.from || "—")} → ${(p.destination || p.toPlace || "—")}`;
  const header = `<h1 style="margin:0 0 10px 0;font-size:20px;line-height:28px;color:#111;">Ny offertförfrågan</h1>
  <p style="margin:0 0 16px 0;color:#374151;font-size:14px;">${escapeHtml(subjectLine)}</p>`;

  const customerBlock = `
  ${sectionTitle("Kund")}
  <table role="presentation" width="100%" cellpadding="0" cellspacing="0" style="border:1px solid #eee;border-radius:10px;overflow:hidden;margin-bottom:12px;">
    ${kv("Namn / referens", p.customerName || p.contact_person || "—")}
    ${kv("E-post", pickEmail(p.to, p.customerEmail, p.customer_email, p.contact_email) || "—")}
    ${kv("Telefon", p.customerPhone || p.customer_phone || "—")}
  </table>`;

  const body = `
    ${header}
    ${itineraryBlock(p)}
    ${customerBlock}
    ${cta(adminUrl, "Öppna i Admin")}
  `;
  return wrapHtml({ title: "Ny offertförfrågan", preheader: "Ny offert inkommen", body });
}

function renderOfferToCustomerHTML(p: MailCorePayload, customerUrl: string) {
  const title = `Offert ${p.offerNumber}`;
  const lead = `<h1 style="margin:0 0 10px 0;font-size:20px;line-height:28px;color:#111;">${escapeHtml(title)}</h1>
  <p style="margin:0 0 16px 0;color:#374151;font-size:14px;">
    Här är din offert. Öppna länken för att granska detaljer och bekräfta.
  </p>`;

  const body = `
    ${lead}
    ${itineraryBlock(p)}
    ${cta(customerUrl, "Visa & bekräfta")}
  `;
  return wrapHtml({ title, preheader: `Din offert är klar – ${p.offerNumber}`, body });
}

// ====== Avsändning via Resend ======
const resend = RESEND_API_KEY ? new Resend(RESEND_API_KEY) : null;

async function sendWithResend(input: {
  from: string;
  to: string | string[];
  subject: string;
  html: string;
  replyTo?: string;
  bcc?: string[];
}) {
  if (!resend) throw new Error("RESEND_API_KEY saknas");
  return resend.emails.send({
    from: input.from,
    to: safeTo(input.to),
    subject: input.subject,
    html: input.html,
    reply_to: input.replyTo,
    bcc: (MAIL_BCC_ALL ? commaSplit(MAIL_BCC_ALL) : []).concat(input.bcc || []),
  });
}

// ====== Publika funktioner ======

/** Skicka kundkvitto (bekräftelse till kund) och Admin-notis. */
export async function sendCustomerReceipt(p: MailCorePayload, _opts?: SendOpts) {
  const to =
    pickEmail(p.to, p.customerEmail, p.customer_email, p.contact_email) ||
    ""; // tomt -> kastas av resend med tydligt fel

  const customerUrl = buildOfferPublicLink(p.offerId, p.offerNumber);
  const html = renderCustomerReceiptHTML(p, customerUrl);

  // 1) Till kunden
  await sendWithResend({
    from: MAIL_FROM,
    to: to,
    subject: `Tack! Vi har mottagit din offertförfrågan (${p.offerNumber})`,
    html,
    replyTo: EMAIL_REPLY_TO || undefined,
  });

  // 2) Admin-notis
  const adminUrl = buildAdminOfferLink(p.offerId, p.offerNumber);
  const adminHtml = renderAdminNewOfferHTML(p, adminUrl);
  await sendWithResend({
    from: MAIL_FROM,
    to: OFFERS_INBOX || ADMIN_ALERT_EMAIL || MAIL_FROM,
    subject: `Ny offertförfrågan: ${p.offerNumber}`,
    html: adminHtml,
    replyTo: EMAIL_REPLY_TO || undefined,
  });
}

/** Skicka själva offerten till kunden. */
export async function sendOfferMail(p: MailCorePayload, _opts?: SendOpts) {
  const to =
    pickEmail(p.to, p.customerEmail, p.customer_email, p.contact_email) ||
    ""; // måste finnas

  const customerUrl = buildOfferPublicLink(p.offerId, p.offerNumber);
  const html = renderOfferToCustomerHTML(p, customerUrl);

  await sendWithResend({
    from: MAIL_FROM,
    to,
    subject: `Offert ${p.offerNumber} – Helsingbuss`,
    html,
    replyTo: EMAIL_REPLY_TO || undefined,
    bcc: commaSplit(OFFERS_INBOX),
  });
}

export { buildOfferPublicLink, buildAdminOfferLink };
