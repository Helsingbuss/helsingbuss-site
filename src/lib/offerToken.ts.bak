// src/lib/offerToken.ts
import jwt, { SignOptions, Secret, JwtPayload } from "jsonwebtoken";

/**
 * Hemlig nyckel för offert-token (måste finnas i miljön).
 * - Lokal/dev: funkar ändå (returnerar "debug-token") om nyckeln saknas.
 * - Prod: sätt OFFER_JWT_SECRET i Vercel Project → Settings → Environment Variables.
 */
const SECRET = process.env.OFFER_JWT_SECRET || "";

/** Payload för offert-token. */
export type OfferTokenPayload = {
  /** Offertens primärnyckel (id i DB). */
  id: string;
  /** Offertnummer, t.ex. "HB25009". */
  no?: string;
  /** Roller: "customer" eller "admin" (informativt). */
  role?: "customer" | "admin" | string;
  /** Standard JWT-fält (iat/exp). */
  iat?: number;
  exp?: number;

  /** Legacy: vissa gamla token använde "sub" istället för "id". */
  sub?: string;
};

/** Intern hjälpare – om du verkligen behöver hard-faila när secret saknas. */
function assertSecret() {
  if (!SECRET) throw new Error("OFFER_JWT_SECRET saknas i miljön");
}

/** Små util-funktioner för bas-URL:er (tar sista icke-tomma variabeln och trimmar "/"). */
function trimEndSlash(u?: string | null) {
  return (u || "").replace(/\/+$/, "");
}
function resolveCustomerBaseUrl() {
  return trimEndSlash(
    process.env.NEXT_PUBLIC_CUSTOMER_BASE_URL ||
      process.env.CUSTOMER_BASE_URL ||
      process.env.NEXT_PUBLIC_BASE_URL ||
      process.env.NEXT_PUBLIC_LOGIN_BASE_URL ||
      ""
  );
}
function resolveAdminBaseUrl() {
  return trimEndSlash(
    process.env.NEXT_PUBLIC_BASE_URL ||
      process.env.NEXT_PUBLIC_LOGIN_BASE_URL ||
      process.env.ADMIN_BASE_URL ||
      ""
  );
}

/**
 * Skapar en signerad offert-token.
 * exp kan vara t.ex. "14d" eller antal sekunder (number).
 */
export function createOfferToken(
  payload: { id: string; no?: string; role?: string },
  exp: string | number = "14d"
): string {
  // I dev utan secret: returnera debug-token så flödet funkar.
  if (!SECRET) return "debug-token";
  type Exp = NonNullable<SignOptions["expiresIn"]>;
  const opts: SignOptions = {
    algorithm: "HS256" as any,
    expiresIn: exp as Exp,
  };
  return jwt.sign(payload as any, SECRET as Secret, opts);
}

/** Legacy alias – vissa äldre filer kanske importerar denna. */
export const signOfferToken = createOfferToken;

/**
 * Verifierar en offert-token. Returnerar payload eller null vid ogiltig/utgången.
 * Stöd för legacy "sub" → mappas till "id" om "id" saknas.
 */
export function verifyOfferToken(token?: string | null): OfferTokenPayload | null {
  if (!token) return null;
  if (!SECRET) return null; // i dev utan secret kan vi inte verifiera
  try {
    const decoded = jwt.verify(token, SECRET as Secret) as JwtPayload | OfferTokenPayload;
    const out: OfferTokenPayload = { ...(decoded as any) };
    if (!out.id && (decoded as any)?.sub) out.id = String((decoded as any).sub);
    return out;
  } catch {
    return null;
  }
}

/**
 * Bygger publik kundlänk till offerten med token som query (både `token` och `t` för kompatibilitet).
 * Ex: https://kund.helsingbuss.se/offert/HB25009?view=inkommen&token=...&t=...
 */
export function buildOfferPublicLink(
  id: string,
  offerNumber: string,
  tokenExp: string | number = "14d"
): string {
  const base = resolveCustomerBaseUrl();
  const token = createOfferToken({ id, no: offerNumber, role: "customer" }, tokenExp);
  const n = encodeURIComponent(offerNumber);
  const t = encodeURIComponent(token);
  return `${base}/offert/${n}?view=inkommen&token=${t}&t=${t}`;
}

/**
 * Bygger admin-länk till offerten i Admin (med token för ev. deep-linking).
 * Ex: https://login.helsingbuss.se/admin/offers/HB25009?token=...&t=...
 */
export function buildAdminOfferLink(
  id: string,
  offerNumber: string,
  tokenExp: string | number = "14d"
): string {
  const base = resolveAdminBaseUrl();
  const token = createOfferToken({ id, no: offerNumber, role: "admin" }, tokenExp);
  const n = encodeURIComponent(offerNumber);
  const t = encodeURIComponent(token);
  return `${base}/admin/offers/${n}?token=${t}&t=${t}`;
}

/** (Valfritt) exportera bas-URL-resolver om du vill använda dem på fler ställen. */
export const _internal = {
  resolveCustomerBaseUrl,
  resolveAdminBaseUrl,
  trimEndSlash,
};
