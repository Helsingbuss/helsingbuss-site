// src/pages/api/offert/send-offer.ts
import type { NextApiRequest, NextApiResponse } from "next";
import supabase from "@/lib/supabaseAdmin";
import { sendOfferMail } from "@/lib/sendOfferMail";
import { buildOfferPublicLink, buildAdminOfferLink } from "@/lib/offerToken";

const MAIL_FROM      = process.env.MAIL_FROM || process.env.EMAIL_FROM || "Helsingbuss <info@helsingbuss.se>";
const EMAIL_REPLY_TO = process.env.EMAIL_REPLY_TO || "";
const MAIL_FORCE_TO  = (process.env.MAIL_FORCE_TO || "").trim();
const MAIL_BCC_ALL   = (process.env.MAIL_BCC_ALL || "")
  .split(",")
  .map(s => s.trim())
  .filter(Boolean);

export default async function handler(req: NextApiRequest, res: NextApiResponse) {
  try {
    if (req.method !== "POST") return res.status(405).json({ error: "Method not allowed" });

    // id kan komma via body eller query (behåll kompatibilitet)
    const id = String((req.body?.id ?? req.query?.id) || "");
    if (!id) return res.status(400).json({ error: "Saknar offert-id" });

    const { data: offer, error } = await supabase
      .from("offers")
      .select([
        "id",
        "offer_number",
        "contact_person",
        "customer_email",
        "customer_phone",
        "departure_place",
        "destination",
        "departure_date",
        "departure_time",
        "passengers",
        "stopover_places",
        "return_departure",
        "return_destination",
        "return_date",
        "return_time",
      ].join(","))
      .eq("id", id)
      .maybeSingle();

    if (error) throw error;
    if (!offer) return res.status(404).json({ error: "Offerten hittades inte" });

    const offerNumber = String(offer.offer_number || "—");
    const adminLink   = buildAdminOfferLink(offer.id, offerNumber);
    const custLink    = buildOfferPublicLink(offer.id, offerNumber);

    // Bestäm kundens e-post — force override om MAIL_FORCE_TO används
    const customerTo = MAIL_FORCE_TO || (offer.customer_email || "").trim();
    if (!customerTo || !customerTo.includes("@")) {
      return res.status(400).json({ error: "Saknar giltig kund-e-postadress" });
    }

    await sendOfferMail({
      offerId: offer.id,
      offerNumber,
      to: customerTo,                        // ✅ till kunden
      from: MAIL_FROM,
      replyTo: EMAIL_REPLY_TO || undefined,
      bcc: MAIL_BCC_ALL.length ? MAIL_BCC_ALL : undefined,
      subject: `Din offert ${offerNumber} från Helsingbuss`,
      customerName: offer.contact_person ?? null,
      customerPhone: offer.customer_phone ?? null,
      fromPlace: offer.departure_place ?? null,
      toPlace: offer.destination ?? null,
      date: offer.departure_date ?? null,
      time: offer.departure_time ?? null,
      passengers: typeof offer.passengers === "number" ? offer.passengers : null,
      returnFrom: offer.return_departure ?? null,
      returnTo: offer.return_destination ?? null,
      returnDate: offer.return_date ?? null,
      returnTime: offer.return_time ?? null,
      customerLink: custLink,
      adminLink,
    });

    return res.status(200).json({ ok: true });
  } catch (e: any) {
    console.error("offert/send-offer error:", e?.message || e);
    return res.status(500).json({ error: e?.message || "Serverfel" });
  }
}
